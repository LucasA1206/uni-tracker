// Prisma schema for Uni & Work tracker
// SQLite is used for simplicity (works locally and on Vercel with file-based DB).

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  universityEmail String @unique
  id              Int              @id @default(autoincrement())
  name            String
  username        String           @unique
  passwordHash    String
  role            String           @default("user") // "user" | "admin"

  canvasApiToken  String?

  uniCourses      UniCourse[]
  workTasks       WorkTask[]
  notes           Note[]
  events          CalendarEvent[]
  microsoftTokens MicrosoftToken[]
  gmailTokens     GmailToken[]
  emailMessages   EmailMessage[]
  people          Person[]
}


model UniCourse {
  id          Int           @id @default(autoincrement())
  user        User          @relation(fields: [userId], references: [id])
  userId      Int
  name        String
  code        String
  canvasId    String?
  assignments Assignment[]
  notes       Note[]

  @@unique([userId, canvasId])
  @@index([userId])
}

model Assignment {
  id             Int        @id @default(autoincrement())
  course         UniCourse  @relation(fields: [courseId], references: [id])
  courseId       Int
  title          String
  description    String?
  dueDate        DateTime
  weight         Float
  maxGrade       Float
  grade          Float?
  status         String     @default("pending")
  followupPeople String?    // JSON-encoded array of people names
  canvasId       String?

  @@unique([courseId, canvasId])
  @@index([courseId])
  @@index([dueDate])
  @@index([status])
}

model Note {
  id          Int        @id @default(autoincrement())
  user        User       @relation(fields: [userId], references: [id])
  userId      Int
  course      UniCourse? @relation(fields: [courseId], references: [id])
  courseId    Int?
  title       String
  content     String
  createdAt   DateTime   @default(now())

  @@index([userId])
  @@index([courseId])
  @@index([createdAt])
}

model WorkTask {
  id             Int      @id @default(autoincrement())
  user           User     @relation(fields: [userId], references: [id])
  userId         Int
  title          String
  context        String?
  status         String   @default("todo")
  dueDate        DateTime?
  source         String?
  externalId     String?
  followupPeople String?  // JSON-encoded array of people names

  @@index([userId])
  @@index([userId, status])
  @@index([dueDate])
}

model CalendarEvent {
  id              Int       @id @default(autoincrement())
  user            User      @relation(fields: [userId], references: [id])
  userId          Int
  title           String
  description     String?
  start           DateTime
  end             DateTime
  type            String
  sourceId        String?
  sourceExtraJson String?

  @@index([userId])
  @@index([userId, start])
}

model MicrosoftToken {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id])
  userId       Int      @unique
  accessToken  String
  refreshToken String
  expiresAt    DateTime
}

model GmailToken {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id])
  userId       Int      @unique
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  email        String?  // Store the connected email address
}

model EmailMessage {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  messageId   String   @unique
  subject     String
  from        String
  receivedAt  DateTime
  preview     String?
  isTask      Boolean  @default(false)
  rawJson     String?
  hidden      Boolean  @default(false)
}

model Person {
  id     Int    @id @default(autoincrement())
  user   User   @relation(fields: [userId], references: [id])
  userId Int
  name   String

  @@unique([userId, name])
}
